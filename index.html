<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nebula Writer â€” Forge Ã  Histoires</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Outfit:wght@200;300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
  :root {
    --bg-deep: #0a0a12;
    --bg-surface: rgba(14, 14, 28, 0.85);
    --bg-card: rgba(20, 18, 40, 0.7);
    --accent-nebula: #7b2ff7;
    --accent-star: #f0c27f;
    --accent-nova: #e84393;
    --accent-aurora: #00cec9;
    --text-primary: #e8e6f0;
    --text-muted: #8a86a0;
    --text-dim: #5a5670;
    --border-glow: rgba(123, 47, 247, 0.3);
    --font-display: 'Cormorant Garamond', serif;
    --font-body: 'Outfit', sans-serif;
  }

  html.dark {
    --bg-deep: #0a0a12;
    --bg-surface: rgba(14, 14, 28, 0.85);
    --bg-card: rgba(20, 18, 40, 0.7);
    --text-primary: #e8e6f0;
    --text-muted: #8a86a0;
    --text-dim: #5a5670;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    width: 100%; height: 100%;
    overflow-x: hidden;
    background: var(--bg-deep);
    color: var(--text-primary);
    font-family: var(--font-body);
  }

  /* === CANVAS BACKGROUND === */
  #nebula-canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 0;
    pointer-events: none;
  }

  /* === MAIN LAYOUT === */
  .app-wrapper {
    position: relative;
    z-index: 1;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem 1rem;
  }

  /* === HEADER === */
  .app-header {
    text-align: center;
    margin-bottom: 2.5rem;
    animation: fadeSlideDown 1s ease-out;
  }

  .app-header h1 {
    font-family: var(--font-display);
    font-weight: 300;
    font-size: clamp(2.4rem, 6vw, 4rem);
    letter-spacing: 0.08em;
    background: linear-gradient(135deg, var(--accent-star) 0%, var(--accent-nebula) 50%, var(--accent-nova) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 0 30px rgba(123, 47, 247, 0.3));
  }

  .app-header .subtitle {
    font-family: var(--font-display);
    font-style: italic;
    font-weight: 300;
    font-size: clamp(0.95rem, 2vw, 1.15rem);
    color: var(--text-muted);
    margin-top: 0.4rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  /* === GENRE SELECTOR === */
  .genre-section {
    width: 100%;
    max-width: 700px;
    margin-bottom: 2rem;
    animation: fadeSlideUp 1s ease-out 0.2s both;
  }

  .genre-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--text-dim);
    margin-bottom: 0.8rem;
  }

  .genre-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 0.6rem;
  }

  .genre-btn {
    position: relative;
    padding: 0.7rem 0.5rem;
    border: 1px solid rgba(123, 47, 247, 0.15);
    border-radius: 12px;
    background: var(--bg-card);
    color: var(--text-muted);
    font-family: var(--font-body);
    font-size: 0.82rem;
    font-weight: 300;
    cursor: pointer;
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: center;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
  }

  .genre-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--accent-nebula), var(--accent-nova));
    opacity: 0;
    transition: opacity 0.35s;
  }

  .genre-btn:hover { border-color: var(--accent-nebula); color: var(--text-primary); }
  .genre-btn:hover::before { opacity: 0.1; }

  .genre-btn.active {
    border-color: var(--accent-nebula);
    color: #fff;
    box-shadow: 0 0 20px rgba(123, 47, 247, 0.25), inset 0 0 20px rgba(123, 47, 247, 0.1);
  }
  .genre-btn.active::before { opacity: 0.2; }

  .genre-btn .genre-icon {
    display: block;
    font-size: 1.3rem;
    margin-bottom: 0.3rem;
  }

  .genre-btn span { position: relative; z-index: 1; }

  /* === PROMPT INPUT === */
  .prompt-section {
    width: 100%;
    max-width: 700px;
    margin-bottom: 2rem;
    animation: fadeSlideUp 1s ease-out 0.4s both;
  }

  .input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.6rem;
    background: var(--bg-card);
    border: 1px solid rgba(123, 47, 247, 0.15);
    border-radius: 16px;
    padding: 0.5rem 0.6rem 0.5rem 1.2rem;
    transition: border-color 0.3s, box-shadow 0.3s;
  }

  .input-wrapper:focus-within {
    border-color: var(--accent-nebula);
    box-shadow: 0 0 30px rgba(123, 47, 247, 0.15);
  }

  .input-wrapper input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    color: var(--text-primary);
    font-family: var(--font-body);
    font-size: 16px;
    font-weight: 300;
    padding: 0.6rem 0;
  }

  .input-wrapper input::placeholder {
    color: var(--text-dim);
    font-style: italic;
  }

  .btn-generate {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.7rem 1.4rem;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--accent-nebula), var(--accent-nova));
    color: #fff;
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 400;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
  }

  .btn-generate:hover { filter: brightness(1.15); transform: translateY(-1px); }
  .btn-generate:active { transform: translateY(0); }
  .btn-generate:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: none;
    transform: none;
  }

  .btn-generate .spinner {
    width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: none;
  }

  .btn-generate.loading .spinner { display: block; }
  .btn-generate.loading .btn-text { display: none; }

  /* === STORY OUTPUT === */
  .story-section {
    width: 100%;
    max-width: 700px;
    animation: fadeSlideUp 0.6s ease-out;
  }

  .story-card {
    position: relative;
    background: var(--bg-surface);
    border: 1px solid rgba(123, 47, 247, 0.12);
    border-radius: 20px;
    padding: 2rem 1.8rem;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    overflow: hidden;
    display: none;
  }

  .story-card.visible { display: block; animation: storyReveal 0.8s ease-out; }

  .story-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-nebula), var(--accent-nova), var(--accent-aurora));
  }

  .story-meta {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 1.2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(123, 47, 247, 0.1);
  }

  .story-genre-tag {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--accent-nebula);
    background: rgba(123, 47, 247, 0.1);
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
  }

  .story-theme-tag {
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    color: var(--text-dim);
    font-style: italic;
  }

  .story-content {
    font-family: var(--font-display);
    font-size: clamp(1.05rem, 2.5vw, 1.2rem);
    font-weight: 300;
    line-height: 1.85;
    color: var(--text-primary);
    white-space: pre-wrap;
  }

  .story-content .cursor-blink {
    display: inline-block;
    width: 2px;
    height: 1.1em;
    background: var(--accent-nebula);
    margin-left: 2px;
    vertical-align: text-bottom;
    animation: blink 1s step-end infinite;
  }

  .story-actions {
    display: flex;
    gap: 0.6rem;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(123, 47, 247, 0.1);
    flex-wrap: wrap;
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    border: 1px solid rgba(123, 47, 247, 0.2);
    border-radius: 10px;
    background: transparent;
    color: var(--text-muted);
    font-family: var(--font-body);
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.3s;
    -webkit-tap-highlight-color: transparent;
  }

  .action-btn:hover {
    border-color: var(--accent-nebula);
    color: var(--text-primary);
    background: rgba(123, 47, 247, 0.08);
  }

  .action-btn.copied {
    border-color: var(--accent-aurora);
    color: var(--accent-aurora);
  }

  /* === HISTORY SECTION === */
  .history-section {
    width: 100%;
    max-width: 700px;
    margin-top: 2.5rem;
  }

  .history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .history-title {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 400;
    color: var(--text-muted);
    letter-spacing: 0.05em;
  }

  .history-count {
    font-size: 0.7rem;
    color: var(--text-dim);
    background: var(--bg-card);
    padding: 0.2rem 0.7rem;
    border-radius: 20px;
  }

  .history-list {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }

  .history-item {
    background: var(--bg-card);
    border: 1px solid rgba(123, 47, 247, 0.08);
    border-radius: 14px;
    padding: 1rem 1.2rem;
    cursor: pointer;
    transition: all 0.3s;
  }

  .history-item:hover {
    border-color: rgba(123, 47, 247, 0.2);
    background: rgba(20, 18, 40, 0.9);
  }

  .history-item-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
  }

  .history-item-genre {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--accent-nebula);
  }

  .history-item-theme {
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .history-item-preview {
    font-family: var(--font-display);
    font-size: 0.9rem;
    color: var(--text-muted);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* === LOADING STATE === */
  .loading-overlay {
    display: none;
    text-align: center;
    padding: 3rem 1rem;
    width: 100%;
    max-width: 700px;
  }

  .loading-overlay.visible { display: block; animation: fadeSlideUp 0.5s ease-out; }

  .loading-orb {
    width: 60px; height: 60px;
    margin: 0 auto 1.5rem;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, var(--accent-nebula), var(--accent-nova));
    animation: orbPulse 2s ease-in-out infinite;
    box-shadow: 0 0 40px rgba(123, 47, 247, 0.4);
  }

  .loading-text {
    font-family: var(--font-display);
    font-style: italic;
    font-size: 1rem;
    color: var(--text-muted);
    letter-spacing: 0.05em;
  }

  /* === TOAST === */
  .toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--bg-surface);
    border: 1px solid var(--accent-aurora);
    color: var(--accent-aurora);
    padding: 0.7rem 1.4rem;
    border-radius: 12px;
    font-size: 0.82rem;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    z-index: 100;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }

  .toast.show { transform: translateX(-50%) translateY(0); }

  /* === ERROR STATE === */
  .error-message {
    display: none;
    width: 100%;
    max-width: 700px;
    background: rgba(232, 67, 147, 0.08);
    border: 1px solid rgba(232, 67, 147, 0.2);
    border-radius: 14px;
    padding: 1rem 1.4rem;
    color: var(--accent-nova);
    font-size: 0.85rem;
    text-align: center;
    margin-bottom: 1rem;
  }

  .error-message.visible { display: block; animation: fadeSlideUp 0.3s ease-out; }

  /* === ANIMATIONS === */
  @keyframes fadeSlideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeSlideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes storyReveal {
    from { opacity: 0; transform: translateY(30px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes blink { 50% { opacity: 0; } }

  @keyframes orbPulse {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.15); opacity: 1; }
  }

  /* === RESPONSIVE === */
  @media (max-width: 600px) {
    .app-wrapper { padding: 1.5rem 0.8rem; }
    .genre-grid { grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
    .genre-btn { padding: 0.6rem 0.3rem; font-size: 0.75rem; }
    .genre-btn .genre-icon { font-size: 1.1rem; }
    .story-card { padding: 1.4rem 1.2rem; border-radius: 16px; }
    .input-wrapper { padding: 0.4rem 0.5rem 0.4rem 1rem; }
    .btn-generate { padding: 0.7rem 1rem; }
    .story-actions { gap: 0.4rem; }
    .action-btn { padding: 0.45rem 0.75rem; font-size: 0.72rem; }
  }
</style>
</head>
<body>
<canvas id="nebula-canvas"></canvas>

<div class="app-wrapper">
  <header class="app-header">
    <h1>Nebula Writer</h1>
    <p class="subtitle">Forge Ã  histoires cosmique</p>
  </header>

  <section class="genre-section">
    <p class="genre-label">Choisissez un univers</p>
    <div class="genre-grid" id="genreGrid"></div>
  </section>

  <section class="prompt-section">
    <div class="input-wrapper">
      <input type="text" id="themeInput" placeholder="DÃ©crivez votre thÃ¨me... ex: un phare oubliÃ© au bout du monde" maxlength="300">
      <button class="btn-generate" id="generateBtn" onclick="generateStory()">
        <span class="btn-text"><i class="fa-solid fa-wand-magic-sparkles"></i> CrÃ©er</span>
        <span class="spinner"></span>
      </button>
    </div>
  </section>

  <div class="error-message" id="errorMsg"></div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-orb"></div>
    <p class="loading-text">Les Ã©toiles tissent votre rÃ©cit...</p>
  </div>

  <section class="story-section" id="storySection">
    <div class="story-card" id="storyCard">
      <div class="story-meta">
        <span class="story-genre-tag" id="storyGenreTag"></span>
        <span class="story-theme-tag" id="storyThemeTag"></span>
      </div>
      <div class="story-content" id="storyContent"></div>
      <div class="story-actions" id="storyActions">
        <button class="action-btn" onclick="copyStory()"><i class="fa-regular fa-copy"></i> Copier</button>
        <button class="action-btn" onclick="generateStory()"><i class="fa-solid fa-rotate"></i> RegÃ©nÃ©rer</button>
        <button class="action-btn" onclick="readAloud()"><i class="fa-solid fa-volume-high"></i> Lire</button>
      </div>
    </div>
  </section>

  <section class="history-section" id="historySection" style="display:none;">
    <div class="history-header">
      <span class="history-title">RÃ©cits prÃ©cÃ©dents</span>
      <span class="history-count" id="historyCount"></span>
    </div>
    <div class="history-list" id="historyList"></div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script>
// === DARK MODE DETECTION ===
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
  document.documentElement.classList.toggle('dark', event.matches);
});

// === GENRES DATA ===
const genres = [
  { id: 'fantasy', label: 'Fantasy', icon: 'ðŸ‰', prompt: 'fantaisie Ã©pique avec magie et crÃ©atures mythiques' },
  { id: 'scifi', label: 'Sci-Fi', icon: 'ðŸš€', prompt: 'science-fiction futuriste avec technologies avancÃ©es' },
  { id: 'horror', label: 'Horreur', icon: 'ðŸŒ‘', prompt: 'horreur atmosphÃ©rique avec tension et mystÃ¨re' },
  { id: 'romance', label: 'Romance', icon: 'ðŸŒ¹', prompt: 'romance poÃ©tique avec des Ã©motions profondes' },
  { id: 'noir', label: 'Noir', icon: 'ðŸ•µï¸', prompt: 'polar noir avec intrigue et ambiance sombre' },
  { id: 'fable', label: 'Fable', icon: 'ðŸ¦Š', prompt: 'fable philosophique avec une morale subtile' },
  { id: 'cosmic', label: 'Cosmique', icon: 'âœ¨', prompt: 'rÃ©cit cosmique contemplant l\'immensitÃ© de l\'univers' },
  { id: 'myth', label: 'Mythologie', icon: 'âš¡', prompt: 'mythologie avec dieux, hÃ©ros et destinÃ©es extraordinaires' },
  { id: 'absurd', label: 'Absurde', icon: 'ðŸŽ­', prompt: 'rÃ©cit absurde, surrÃ©aliste et dÃ©calÃ© avec humour noir' },
];

let selectedGenre = genres[0];
let storyHistory = [];
let currentStory = '';
let isGenerating = false;

// === INIT GENRE GRID ===
function initGenreGrid() {
  const grid = document.getElementById('genreGrid');
  genres.forEach((g, i) => {
    const btn = document.createElement('button');
    btn.className = 'genre-btn' + (i === 0 ? ' active' : '');
    btn.dataset.id = g.id;
    btn.innerHTML = `<span class="genre-icon">${g.icon}</span><span>${g.label}</span>`;
    btn.addEventListener('click', () => selectGenre(g, btn));
    grid.appendChild(btn);
  });
}

function selectGenre(genre, btn) {
  selectedGenre = genre;
  document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

// === STORY GENERATION ===
async function generateStory() {
  if (isGenerating) return;

  const theme = document.getElementById('themeInput').value.trim();
  if (!theme) {
    showError('Veuillez entrer un thÃ¨me pour votre histoire.');
    return;
  }

  isGenerating = true;
  hideError();

  const btn = document.getElementById('generateBtn');
  btn.classList.add('loading');
  btn.disabled = true;

  const storyCard = document.getElementById('storyCard');
  storyCard.classList.remove('visible');

  const loading = document.getElementById('loadingOverlay');
  loading.classList.add('visible');

  const prompt = `Tu es un Ã©crivain de gÃ©nie. Ã‰cris une courte histoire (environ 250-400 mots) en franÃ§ais dans le genre "${selectedGenre.label}" (${selectedGenre.prompt}). Le thÃ¨me imposÃ© est : "${theme}". L'histoire doit Ãªtre captivante, poÃ©tique et avoir une fin mÃ©morable. Ne mets pas de titre, commence directement le rÃ©cit. N'utilise pas de markdown.`;

  const handlerName = 'story-handler-' + Date.now();

  window.Poe.registerHandler(handlerName, (result) => {
    const msg = result.responses[0];

    if (msg.status === 'error') {
      loading.classList.remove('visible');
      btn.classList.remove('loading');
      btn.disabled = false;
      isGenerating = false;
      showError('Erreur : ' + (msg.statusText || 'Impossible de gÃ©nÃ©rer l\'histoire.'));
      return;
    }

    if (msg.status === 'incomplete') {
      loading.classList.remove('visible');
      storyCard.classList.add('visible');
      document.getElementById('storyGenreTag').textContent = selectedGenre.icon + ' ' + selectedGenre.label;
      document.getElementById('storyThemeTag').textContent = 'Â« ' + theme + ' Â»';
      document.getElementById('storyContent').innerHTML = msg.content + '<span class="cursor-blink"></span>';
      document.getElementById('storyActions').style.display = 'none';
      currentStory = msg.content;
    }

    if (msg.status === 'complete') {
      loading.classList.remove('visible');
      storyCard.classList.add('visible');
      document.getElementById('storyGenreTag').textContent = selectedGenre.icon + ' ' + selectedGenre.label;
      document.getElementById('storyThemeTag').textContent = 'Â« ' + theme + ' Â»';
      document.getElementById('storyContent').textContent = msg.content;
      document.getElementById('storyActions').style.display = 'flex';
      currentStory = msg.content;
      btn.classList.remove('loading');
      btn.disabled = false;
      isGenerating = false;
      addToHistory(selectedGenre, theme, msg.content);
    }
  });

  try {
    await window.Poe.sendUserMessage('@Claude-Sonnet-4.5 ' + prompt, {
      handler: handlerName,
      stream: true,
      openChat: false,
      parameters: {}
    });
  } catch (err) {
    loading.classList.remove('visible');
    btn.classList.remove('loading');
    btn.disabled = false;
    isGenerating = false;

    if (err && err.errorType === 'USER_REJECTED_CONFIRMATION') {
      showError('GÃ©nÃ©ration annulÃ©e.');
    } else {
      showError('Erreur : ' + (err.message || err));
    }
  }
}

// === READ ALOUD ===
async function readAloud() {
  if (!currentStory) return;

  const handlerName = 'tts-handler-' + Date.now();

  showToast('GÃ©nÃ©ration audio en cours...');

  window.Poe.registerHandler(handlerName, (result) => {
    const msg = result.responses[0];
    if (msg.status === 'complete') {
      showToast('Audio prÃªt !');
    } else if (msg.status === 'error') {
      showToast('Erreur audio');
    }
  });

  try {
    const textToRead = currentStory.length > 5000 ? currentStory.substring(0, 5000) : currentStory;
    await window.Poe.sendUserMessage('@ElevenLabs-v2.5-Turbo ' + textToRead, {
      handler: handlerName,
      stream: false,
      openChat: true,
      parameters: { voice: 'Jessica', language: 'fr' }
    });
  } catch (err) {
    showToast('Erreur lors de la lecture');
  }
}

// === HISTORY ===
function addToHistory(genre, theme, content) {
  storyHistory.unshift({ genre: {...genre}, theme, content, timestamp: Date.now() });
  if (storyHistory.length > 20) storyHistory.pop();
  renderHistory();
}

function renderHistory() {
  const section = document.getElementById('historySection');
  const list = document.getElementById('historyList');
  const count = document.getElementById('historyCount');

  if (storyHistory.length < 2) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';
  count.textContent = storyHistory.length + ' rÃ©cits';
  list.innerHTML = '';

  storyHistory.slice(1).forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'history-item';
    div.innerHTML = `
      <div class="history-item-header">
        <span class="history-item-genre">${item.genre.icon} ${item.genre.label}</span>
        <span class="history-item-theme">Â· ${item.theme}</span>
      </div>
      <div class="history-item-preview">${item.content}</div>
    `;
    div.addEventListener('click', () => {
      currentStory = item.content;
      document.getElementById('storyGenreTag').textContent = item.genre.icon + ' ' + item.genre.label;
      document.getElementById('storyThemeTag').textContent = 'Â« ' + item.theme + ' Â»';
      document.getElementById('storyContent').textContent = item.content;
      document.getElementById('storyActions').style.display = 'flex';
      document.getElementById('storyCard').classList.add('visible');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    list.appendChild(div);
  });
}

// === COPY ===
async function copyStory() {
  if (!currentStory) return;
  try {
    await navigator.clipboard.writeText(currentStory);
    const btn = document.querySelector('.action-btn');
    btn.classList.add('copied');
    btn.innerHTML = '<i class="fa-solid fa-check"></i> CopiÃ© !';
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = '<i class="fa-regular fa-copy"></i> Copier';
    }, 2000);
  } catch (e) {
    showToast('Impossible de copier');
  }
}

// === UI HELPERS ===
function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.textContent = msg;
  el.classList.add('visible');
}

function hideError() {
  document.getElementById('errorMsg').classList.remove('visible');
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// === ENTER KEY ===
document.getElementById('themeInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') generateStory();
});

// === NEBULA CANVAS ===
(function initNebula() {
  const canvas = document.getElementById('nebula-canvas');
  const ctx = canvas.getContext('2d');
  let w, h;
  const particles = [];
  const PARTICLE_COUNT = 90;

  function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
  }

  function createParticle() {
    return {
      x: Math.random() * w,
      y: Math.random() * h,
      r: Math.random() * 2.5 + 0.5,
      vx: (Math.random() - 0.5) * 0.3,
      vy: (Math.random() - 0.5) * 0.3,
      alpha: Math.random() * 0.5 + 0.1,
      color: ['#7b2ff7', '#e84393', '#f0c27f', '#00cec9'][Math.floor(Math.random() * 4)],
      pulse: Math.random() * Math.PI * 2,
      pulseSpeed: Math.random() * 0.02 + 0.005,
    };
  }

  function init() {
    resize();
    for (let i = 0; i < PARTICLE_COUNT; i++) particles.push(createParticle());
  }

  function drawNebulaGlow() {
    const g1 = ctx.createRadialGradient(w * 0.3, h * 0.4, 0, w * 0.3, h * 0.4, w * 0.5);
    g1.addColorStop(0, 'rgba(123, 47, 247, 0.04)');
    g1.addColorStop(1, 'transparent');
    ctx.fillStyle = g1;
    ctx.fillRect(0, 0, w, h);

    const g2 = ctx.createRadialGradient(w * 0.7, h * 0.6, 0, w * 0.7, h * 0.6, w * 0.4);
    g2.addColorStop(0, 'rgba(232, 67, 147, 0.03)');
    g2.addColorStop(1, 'transparent');
    ctx.fillStyle = g2;
    ctx.fillRect(0, 0, w, h);
  }

  function animate() {
    ctx.clearRect(0, 0, w, h);
    drawNebulaGlow();

    for (const p of particles) {
      p.x += p.vx;
      p.y += p.vy;
      p.pulse += p.pulseSpeed;

      if (p.x < -10) p.x = w + 10;
      if (p.x > w + 10) p.x = -10;
      if (p.y < -10) p.y = h + 10;
      if (p.y > h + 10) p.y = -10;

      const currentAlpha = p.alpha * (0.6 + 0.4 * Math.sin(p.pulse));
      const currentR = p.r * (0.8 + 0.2 * Math.sin(p.pulse));

      ctx.beginPath();
      ctx.arc(p.x, p.y, currentR, 0, Math.PI * 2);
      ctx.fillStyle = p.color;
      ctx.globalAlpha = currentAlpha;
      ctx.fill();

      ctx.beginPath();
      ctx.arc(p.x, p.y, currentR * 3, 0, Math.PI * 2);
      ctx.fillStyle = p.color;
      ctx.globalAlpha = currentAlpha * 0.15;
      ctx.fill();
    }

    ctx.globalAlpha = 1;
    requestAnimationFrame(animate);
  }

  window.addEventListener('resize', resize);
  init();
  animate();
})();

// === INIT ===
initGenreGrid();
</script>
</body>
</html>